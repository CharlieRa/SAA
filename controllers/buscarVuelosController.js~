var mysql = require ('mysql');
var async = require ('async');
require ('./datos_glob');

var buscarVuelos  = function () {};

buscarVuelos.prototype.get= function(req, res) {
	var connection = mysql.createConnection(c_info);
	connection.connect();

	async.parallel({

		    origen: function(callback){
		    	connection.query('SELECT airport.CODE AS acode, city.NAME AS ciname, country.NAME AS coname FROM city join country join airport WHERE city.C_CODE = country.CODE and CITY_ID = city.CODE  ORDER  BY  coname', function(err, result) {
				callback(null, result);
				})
		    },
		    destino: function(callback){
		    	connection.query('SELECT airport.CODE AS acode, city.NAME AS ciname, country.NAME AS coname FROM city join country join airport WHERE city.C_CODE = country.CODE and CITY_ID = city.CODE  ORDER  BY  coname', function(err, result) {
		    		callback(null, result);
				})
		    },

		},
		function(err, results) {
		if(err)
	 	console.log(err);
			res.render('buscarVuelos', { destino: results.destino, origen: results.origen, 	usrname: userdata.username})
		});
	connection.end();
};

buscarVuelos.prototype.enviar= function(req, res) {
	var connection = mysql.createConnection(c_info);
	connection.connect();
	console.log("select ESTIMATED_DEPARTURE, ESTIMATED_DURATION, ORIGIN_CODE, DESTINY_CODE, AIRPLANE_T_MODEL from scheduled_flight join flight where S_FLIGHT_ID = scheduled_flight.ID and ORIGIN_CODE = '"+req.body.org+"' and DESTINY_CODE = '"+req.body.dest+"' and DEPARTURE_TIME like '"+req.body.departureDate+"%'");
	connection.query("select flight.ID AS fid, ESTIMATED_DEPARTURE, ADDTIME(ESTIMATED_DEPARTURE,ESTIMATED_DURATION) AS ESTIMATED_ARRIVAL, ORIGIN_CODE, DESTINY_CODE, AIRPLANE_T_MODEL from scheduled_flight join flight where S_FLIGHT_ID = scheduled_flight.ID and ORIGIN_CODE = '"+req.body.org+"' and DESTINY_CODE = '"+req.body.dest+"' and DEPARTURE_TIME like '"+req.body.departureDate+"%' ORDER  BY  DEPARTURE_TIME", function(err, result) {
 		res.render('vuelosBuscados', { data: result})
 		console.log(result)
	})
	connection.end();
};

module.exports = buscarVuelos;
